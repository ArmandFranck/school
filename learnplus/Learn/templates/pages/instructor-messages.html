
{% extends 'bases/header_i_chat.html' %}

{% block content %}
       
<div class="mdk-drawer-layout__content page ">

    <div data-push data-responsive-width="768px" class="mdk-drawer-layout js-mdk-drawer-layout">
        <div class="mdk-drawer-layout__content">


            <div class="app-messages__container d-flex flex-column h-100 pb-4">
                <div class="navbar navbar-light bg-white navbar-expand-sm navbar-shadow z-1">
                    <div class="container-fluid flex-wrap px-sm-0">
                        <div class="nav py-2">
                            <div class="nav-item align-items-center mr-3">
                                <div class="mr-3">
                                    <div class="avatar avatar-online avatar-sm">
                                        <img src="/static/assets/images/people/110/woman-5.jpg" alt="people"
                                            class="avatar-img rounded-circle">
                                    </div>
                                </div>
                                <div class="d-flex flex-column" style="max-width: 200px; font-size: 15px">
                                    <strong class="text-body">Michelle Smith</strong>
                                    <span class="text-muted text-ellipsis">Personal Development Teacher since
                                        2014</span>
                                </div>
                            </div>
                        </div>
                        <div class="py-2 flex d-flex align-items-center">
                            <div class="flex search-form form-control-rounded search-form--light"
                                style="min-width: 200px;">
                                <input type="text" class="form-control" placeholder="Search messages"
                                    id="searchSample02">
                                <button class="btn pr-3" type="button" role="button"><i
                                        class="material-icons">search</i></button>
                            </div>
                            <button data-target="#messages-drawer" class="navbar-toggler d-block d-md-none ml-3 p-0"
                                data-toggle="sidebar" type="button">
                                <i class="material-icons">people_outline</i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex pt-4" style="position: relative;" data-perfect-scrollbar>
                    <div class="container-fluid page__container">
                        <div class="jumbotron">
                            <div class="d-flex align-items-center">
                                <div class="mr-3">
                                    <div class="avatar avatar-xl">
                                        <img src="/static/assets/images/people/110/woman-5.jpg" alt="people"
                                            class="avatar-img rounded-circle">
                                    </div>
                                </div>
                                <div class="flex">
                                    <h4 class="mb-0">Michelle Smith</h4>
                                    <p class="text-muted mb-0">Personal Development Teacher since 2014</p>
                                </div>
                            </div>
                        </div>
                        <ul class="d-flex flex-column list-unstyled" id="messages">


                            <li class="message d-inline-flex">
                                <div class="message__aside">
                                    <a href="instructor-profile.html" class="avatar">
                                        <img src="/static/assets/images/people/110/guy-6.jpg" alt="people"
                                            class="avatar-img rounded-circle">
                                    </a>
                                </div>
                                <div class="message__body card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex mr-3">
                                                <a href="instructor-profile.html" class="text-body"><strong>Laza
                                                        Bogdan</strong></a>
                                            </div>
                                            <div>
                                                <small class="text-muted">1 hour ago</small>
                                            </div>
                                        </div>
                                        <span class="text-black-70">Coming along nicely, we&#39;ve got a draft for the
                                            client design completed, take a look! ðŸ¤“</span>

                                        <a href="#"
                                            class="media align-items-center mt-2 text-decoration-0 bg-white px-3">
                                            <span class="avatar mr-2">
                                                <span class="avatar-title rounded-circle">
                                                    <i class="material-icons font-size-24pt">attach_file</i>
                                                </span>
                                            </span>
                                            <span class="media-body" style="line-height: 1.5">
                                                <span class="text-primary">draft.sketch</span><br>
                                                <span class="text-muted">5 MB</span>
                                            </span>
                                        </a>

                                    </div>
                                </div>
                            </li>

                            <li class="message d-inline-flex">
                                <div class="message__aside">
                                    <a href="instructor-profile.html" class="avatar">
                                        <img src="/static/assets/images/people/110/woman-5.jpg" alt="people"
                                            class="avatar-img rounded-circle">
                                    </a>
                                </div>
                                <div class="message__body card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex mr-3">
                                                <a href="instructor-profile.html"
                                                    class="text-body"><strong>Michelle</strong></a>
                                            </div>
                                            <div>
                                                <small class="text-muted">5 minutes ago</small>
                                            </div>
                                        </div>
                                        <span class="text-black-70">Clients loved the new design.</span>

                                    </div>
                                </div>
                            </li>

                            <li class="message d-inline-flex">
                                <div class="message__aside">
                                    <a href="instructor-profile.html" class="avatar">
                                        <img src="/static/assets/images/people/110/woman-5.jpg" alt="people"
                                            class="avatar-img rounded-circle">
                                    </a>
                                </div>
                                <div class="message__body card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex mr-3">
                                                <a href="instructor-profile.html"
                                                    class="text-body"><strong>Michelle</strong></a>
                                            </div>
                                            <div>
                                                <small class="text-muted">5 minutes ago</small>
                                            </div>
                                        </div>
                                        <span class="text-black-70">ðŸ”¥ Superb job..</span>

                                    </div>
                                </div>
                            </li>

                            <li class="message d-inline-flex">
                                <div class="message__aside">
                                    <a href="instructor-profile.html" class="avatar">
                                        <img src="/static/assets/images/people/110/guy-6.jpg" alt="people"
                                            class="avatar-img rounded-circle">
                                    </a>
                                </div>
                                <div class="message__body card">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex mr-3">
                                                <a href="instructor-profile.html" class="text-body"><strong>Laza
                                                        Bogdan</strong></a>
                                            </div>
                                            <div>
                                                <small class="text-muted">just now</small>
                                            </div>
                                        </div>
                                        <span class="text-black-70">Glad it all worked out ðŸ˜‰</span>

                                    </div>
                                </div>
                            </li>


                        </ul>
                    </div>
                </div>
                <div class="container-fluid page__container">
                    <form action="#" id="message-reply">
                        <div class="input-group input-group-merge">
                            <input type="text" id="chat-message-input" class="form-control form-control-appended" autofocus="" required=""
                                placeholder="Type message">
                            <div class="input-group-append">
                                <div class="input-group-text pr-2">
                                    <button class="btn btn-flush" type="button"><i
                                         id="chat-message-submit"   class="material-icons">send</i></button>
                                </div>

                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>



        <div class="mdk-drawer js-mdk-drawer" data-align="end" id="messages-drawer">
            <div class="mdk-drawer__content top-0">
                <div class="sidebar sidebar-right sidebar-light bg-white o-hidden">
                    <div class="d-flex flex-column h-100">
                        <div class="d-flex flex-column justify-content-center navbar-height">
                            <div class="px-3 form-group mb-0">
                                <div class="input-group input-group-merge input-group-rounded flex-nowrap">
                                    <input type="text" class="form-control form-control-prepended"
                                        placeholder="Filter members">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            <span class="material-icons">filter_list</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>







                        <div class="flex" data-perfect-scrollbar>
                            <div class="sidebar-heading">Online</div>
                            <ul class="list-group list-group-fit mb-3">


                                <li class="list-group-item px-4 py-3 bg-light">
                                    <a href="#" class="d-flex align-items-center position-relative">
                                        <span class="avatar avatar-sm avatar-online mr-3 flex-shrink-0">

                                            <img src="/static/assets/images/people/50/woman-5.jpg" alt="Avatar"
                                                class="avatar-img rounded-circle">

                                        </span>
                                        <span class="flex d-flex flex-column" style="max-width: 175px;">
                                            <strong class="text-body">Michelle Smith</strong>

                                            <span class="text-muted text-ellipsis">Personal Development Teacher Since
                                                2014</span>

                                        </span>
                                    </a>
                                </li>



                                <li class="list-group-item px-4 py-3">
                                    <a href="#" class="d-flex align-items-center position-relative">
                                        <span class="avatar avatar-sm avatar-online mr-3 flex-shrink-0">

                                            <span class="avatar-title rounded-circle">AD</span>

                                        </span>
                                        <span class="flex d-flex flex-column" style="max-width: 175px;">
                                            <strong class="text-body">Andrew Brain</strong>

                                        </span>
                                    </a>
                                </li>



                                <li class="list-group-item px-4 py-3">
                                    <a href="#" class="d-flex align-items-center position-relative">
                                        <span class="avatar avatar-sm avatar-online mr-3 flex-shrink-0">

                                            <img src="/static/assets/images/people/50/guy-2.jpg" alt="Avatar"
                                                class="avatar-img rounded-circle">

                                        </span>
                                        <span class="flex d-flex flex-column" style="max-width: 175px;">
                                            <strong class="text-body">Jimmy Carter</strong>

                                        </span>
                                    </a>
                                </li>



                                <li class="list-group-item px-4 py-3">
                                    <a href="#" class="d-flex align-items-center position-relative">
                                        <span class="avatar avatar-sm avatar-online mr-3 flex-shrink-0">

                                            <img src="/static/assets/images/people/50/woman-2.jpg" alt="Avatar"
                                                class="avatar-img rounded-circle">

                                        </span>
                                        <span class="flex d-flex flex-column" style="max-width: 175px;">
                                            <strong class="text-body">Samantha Doe</strong>

                                        </span>
                                    </a>
                                </li>


                            </ul>
                            <div class="sidebar-heading d-flex">
                                <div class="flex text-muted">21 OFFLINE</div>
                                <a href="#" class="text-primary">Hide offline</a>
                            </div>
                            <ul class="list-group list-group-fit mb-3">


                                <li class="list-group-item px-4 py-3">
                                    <a href="#" class="d-flex align-items-center position-relative">
                                        <span class="avatar avatar-sm avatar-offline mr-3 flex-shrink-0">

                                            <span class="avatar-title rounded-circle">XD</span>

                                        </span>
                                        <span class="flex d-flex flex-column" style="max-width: 175px;">
                                            <strong class="text-body">Xander Dale</strong>

                                        </span>
                                    </a>
                                </li>



                                <li class="list-group-item px-4 py-3">
                                    <a href="#" class="d-flex align-items-center position-relative">
                                        <span class="avatar avatar-sm avatar-offline mr-3 flex-shrink-0">

                                            <img src="/static/assets/images/people/50/woman-1.jpg" alt="Avatar"
                                                class="avatar-img rounded-circle">

                                        </span>
                                        <span class="flex d-flex flex-column" style="max-width: 175px;">
                                            <strong class="text-body">Beatriz Summers</strong>

                                        </span>
                                    </a>
                                </li>



                                <li class="list-group-item px-4 py-3">
                                    <a href="#" class="d-flex align-items-center position-relative">
                                        <span class="avatar avatar-sm avatar-offline mr-3 flex-shrink-0">

                                            <img src="/static/assets/images/people/50/woman-3.jpg" alt="Avatar"
                                                class="avatar-img rounded-circle">

                                        </span>
                                        <span class="flex d-flex flex-column" style="max-width: 175px;">
                                            <strong class="text-body">Cassie Wills</strong>

                                        </span>
                                    </a>
                                </li>



                                <li class="list-group-item px-4 py-3 bg-light">
                                    <a href="#" class="d-flex align-items-center position-relative">
                                        <span class="avatar avatar-sm avatar-offline mr-3 flex-shrink-0">

                                            <img src="/static/assets/images/people/50/guy-1.jpg" alt="Avatar"
                                                class="avatar-img rounded-circle">

                                        </span>
                                        <span class="flex d-flex flex-column" style="max-width: 175px;">
                                            <strong class="text-body">Jarrod Forrest</strong>

                                            <span class="text-muted text-ellipsis">Arts Teacher</span>

                                        </span>
                                    </a>
                                </li>



                                <li class="list-group-item px-4 py-3">
                                    <a href="#" class="d-flex align-items-center position-relative">
                                        <span class="avatar avatar-sm avatar-offline mr-3 flex-shrink-0">

                                            <img src="/static/assets/images/people/50/guy-3.jpg" alt="Avatar"
                                                class="avatar-img rounded-circle">

                                        </span>
                                        <span class="flex d-flex flex-column" style="max-width: 175px;">
                                            <strong class="text-body">Ziva Ochoa</strong>

                                        </span>
                                    </a>
                                </li>


                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>

{% endblock content %}



{% block script %}

<!-- Messages App -->
<script src="/static/assets/js/messages.js"></script>
<script src="{% static 'assets\js\reconnecting-websocket.js' %}"></script>
<script>
    var classe = {{ classe_json }};
    var username = {{ username }};

    var chatSocket = new ReconnectingWebSocket(
        'wss://' + window.location.host +
        '/ws/messages/' + classe + '/');

    chatSocket.onopen = function (e) {
        fecthMessages();
    }

    chatSocket.onmessage = function (e) {
        var data = JSON.parse(e.data);
        if (data['command'] === 'messages') {
            for (let i = 0; i < data['messages'].length; i++) {
                creataMessage(data['messages'][i]);
                console.log("djdjd")
            }
        } else if (data['command'] === 'new_message') {
            creataMessage(data['message']);
            console.log('sdd')
        }
    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function (e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function (e) {
        var messageInputDom = document.querySelector('#chat-message-input');
        var message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message,
            'command': 'new_message',
            'from': username,
            'classe': classe
        }));

        messageInputDom.value = '';
    };
    function fecthMessages() {
        chatSocket.send(JSON.stringify({
            'command': 'fetch_messages',
            'classe': classe
        }));
    }


    function creataMessage(data) {
        var auteur = data['auteur']
        var msgDivTag = document.createElement('li')
        msgDivTag.setAttribute('class', 'message d-inline-flex');
        // var imgTag = document.createElement('img')
        // var spanTag = document.createElement('span')
        // spanTag.textContent = message.message
        if (auteur === username) {
            msgDivTag.innerHTML = `
    
                <div class="message__aside">
                    <a href="instructor-profile.html" class="avatar">
                        <img src="${data.auteur_image}" alt="people"
                            class="avatar-img rounded-circle">
                    </a>
                </div>
                <div class="message__body card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex mr-3">
                                <a href="instructor-profile.html" class="text-body"><strong>
                                        ${data.auteur}</strong></a>
                            </div>
                            <div>
                                <small class="text-muted">${data.date_add}</small>
                            </div>
                        </div>
                        <span class="text-black-70">${data.message}</span>

                    </div>
                </div>
            `;
        } else {
            msgDivTag.innerHTML = `
            <div class="message__aside">
                <a href="instructor-profile.html" class="avatar">
                    <img src="${data.auteur_image}" alt="people"
                        class="avatar-img rounded-circle">
                </a>
            </div>
            <div class="message__body card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex mr-3">
                            <a href="instructor-profile.html"
                                class="text-body"><strong>${data.auteur}</strong></a>
                        </div>
                        <div>
                            <small class="text-muted">${data.date_add}</small>
                        </div>
                    </div>
                    <span class="text-black-70">${data.message}</span>

                </div>
            </div>
            `;
        }
        // // var div = document.createElement('div');
        // // div.setAttribute('class', 'post block bc2');
        // div.innerHTML = `
        //     <div class="parent">
        //         <div class="child">${a}</div>
        //         <div class="child">+</div>
        //         <div class="child">${b}</div>
        //         <div class="child">=</div>
        //         <div class="child">${a + b}</div>
        //     </div>
        // `;
        // document.getElementById('posts').appendChild(div);
        // // msgDivTag.appendChild(imgTag)
        // msgDivTag.appendChild(spanTag)
        document.querySelector('#chat-log').appendChild(msgDivTag);
    }
</script>
{% endblock script %}
    